on:
    workflow_call:
      outputs:
        image_name:
          description: "The filename of the uploaded base image"
          value: ${{ jobs.build.outputs.image_name }}

jobs:
    build:
      runs-on: ubuntu-latest
      outputs:
        image_name: ${{ steps.artifact.outputs.image }}
      steps:
      - name: Remove unnecessary files
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf "/usr/local/share/boost"
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
      - name: Install Dependencies
        run: |
          sudo apt update
          sudo apt install coreutils p7zip-full qemu-user-static
      - name: Checkout CustomPiOS
        uses: actions/checkout@v4
        with:
          repository: 'guysoft/CustomPiOS'
          path: CustomPiOS
          ref: '70f1ae537a02195f1ba4f0a51ed381628e575c66'
  
      - name: Checkout Project Repository
        uses: actions/checkout@v4
        with:
          path: repository
          submodules: true
  
      - name: Download Raspbian Image
        run: |
          cd repository/src/image
          wget -c --trust-server-names 'https://downloads.raspberrypi.org/raspios_lite_armhf_latest'
      - name: Update CustomPiOS Paths
        run: |
          cd repository/src
          ../../CustomPiOS/src/update-custompios-paths
  
      - name: Build Image
        id: build
        run: |
          sudo modprobe loop
          cd repository/src
          sudo bash -x ./build_dist
  
      - name: Prepare artifact
        id: artifact
        run: |
          source repository/src/config
          NOW=$(date +"%Y-%m-%d-%H%M")
          IMAGE=$NOW-prometheusos-BASE-$DIST_VERSION
          cp repository/src/workspace/*.img $IMAGE.img
          tar -cJf $IMAGE.xz  $IMAGE.img
          echo "image=$IMAGE" >> $GITHUB_OUTPUT
          echo "dist_version=$DIST_VERSION" >> $GITHUB_OUTPUT
  
      - uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.artifact.outputs.image }}
          path: ${{ steps.artifact.outputs.image }}.xz
