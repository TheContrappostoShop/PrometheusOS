#!/usr/bin/env bash
# nanodlp install script
# Installs Odyssey for use on the Prometheus MSLA Printer
# Written by Ada Phillips <ragwafire99@gmail.com
# GPL V3
########


# Source error handling, leave this in place
set -x
set -e

source /common.sh

install_cleanup_trap

check_install_pkgs ${ODYSSEY_DEPS}

pushd "/home/${BASE_USER}"
sudo -u "${BASE_USER}" mkdir -p odyssey

LATEST_RELEASE=$(curl -L -s -H 'Accept: application/json' https://github.com/TheContrappostoShop/Odyssey/releases/latest)
LATEST_VERSION=$(echo $LATEST_RELEASE | sed -e 's/.*"tag_name":"\([^"]*\)".*/\1/')
ODYSSEY_URL="https://github.com/TheContrappostoShop/Odyssey/releases/download/$LATEST_VERSION/odyssey.tar.gz"

sudo -u "${BASE_USER}" wget ${ODYSSEY_URL} -O - | tar -C odyssey/ -xz

# Create scripts for starting and stopping odyssey prints (stop is *unsafe*)
sudo -u "${BASE_USER}" echo """#!/usr/bin/env bash
/home/${BASE_USER}/odyssey/odyssey --config /home/${BASE_USER}/odyssey/odyssey.yaml --file \"\${1}\" &>> /home/${BASE_USER}/printer_data/logs/odyssey.log &
""" > printer_data/scripts/odyssey_start.sh

sudo -u "${BASE_USER}" echo """#!/usr/bin/env bash
killall odyssey
""" > printer_data/scripts/odyssey_stop.sh

sudo -u "${BASE_USER}" chmod +x printer_data/scripts/odyssey_start.sh
sudo -u "${BASE_USER}" chmod +x printer_data/scripts/odyssey_stop.sh

popd

unpack /filesystem/home/pi /home/"${BASE_USER}" "${BASE_USER}"

# Create file watcher service to generate .gcode files from uploaded .sl1 files
pushd "/etc/systemd/system"
echo """[Unit]
Description=Create Odyssey gcode files for every SL1 file uploaded
After=klipper.service

[Service]
ExecStart=/home/${BASE_USER}/odyssey/sl1_watcher.sh
RemainAfterExit=true
Type=simple
User=${BASE_USER}

[Install]
WantedBy=multi-user.target
""" > sl1_watcher.service

systemctl_if_exists enable sl1_watcher.service

popd
